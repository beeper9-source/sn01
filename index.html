<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수내체임버앙상블 출석부 v0.1 </title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA manifest는 로컬 파일 시스템에서 CORS 오류를 발생시킬 수 있으므로 주석 처리 -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#4facfe">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="출석부">
    
    <!-- Supabase 클라이언트 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="logo.png" alt="수내체임버앙상블 로고" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="logo-fallback" style="display: none;">🎼</div>
            <h1>수내체임버앙상블 출석부 v0.2</h1>
            <div class="header-actions">
                <button id="memberManageBtn" class="member-manage-btn">단원 관리</button>
                <button id="sheetMusicManageBtn" class="sheet-music-manage-btn">악보 관리</button>
                <button id="practiceSongManageBtn" class="practice-song-manage-btn">연습곡 관리</button>
                <div class="sync-time" id="syncTime">
                    <span class="sync-time-value" id="syncTimeValue">-</span>
                </div>
            </div>
        </header>

        <div class="class-info">
            <h2>25년 가을학기</h2>
            <p>매주 일요일 | 총 11회차</p>
        </div>

        <div class="session-selector">
            <label for="sessionSelect">회차 선택:</label>
            <select id="sessionSelect">
                <option value="1">1회차 (9/7)</option>
                <option value="2">2회차 (9/14)</option>
                <option value="3">3회차 (9/21)</option>
                <option value="4">4회차 (9/28)</option>
                <option value="5">휴강 (10/5)</option>
                <option value="6">5회차 (10/12)</option>
                <option value="7">6회차 (10/19)</option>
                <option value="8">7회차 (10/26)</option>
                <option value="9">8회차 (11/2)</option>
                <option value="10">9회차 (11/9)</option>
                <option value="11">10회차 (11/16)</option>
                <option value="12">11회차 (11/30) - 종강</option>
            </select>
        </div>

        <!-- 이번 회차 연습곡 표시 -->
        <div class="current-session-songs">
            <h3>이번 회차 연습곡</h3>
            <div id="currentSessionSongsList" class="session-songs-list">
                <div class="no-songs">연습곡이 설정되지 않았습니다.</div>
            </div>
        </div>

        <div class="attendance-summary">
            <div class="summary-item">
                <span class="summary-label">출석:</span>
                <span class="summary-count" id="attendanceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">결석:</span>
                <span class="summary-count" id="absenceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">미정:</span>
                <span class="summary-count" id="pendingCount">0</span>
            </div>
            <div class="summary-item" id="holidaySummary" style="display: none;">
                <span class="summary-label">휴강:</span>
                <span class="summary-count" id="holidayCount">0</span>
            </div>
        </div>

        <div class="instrument-summary">
            <h3>악기별 출석 현황</h3>
            <div class="instrument-grid">
                <div class="instrument-card" data-instrument="바이올린">
                    <div class="instrument-header">
                        <h4>바이올린</h4>
                        <div class="header-right">
                            <span class="member-count" id="violin-count">-명</span>
                            <span class="attendance-rate" id="violin-rate"></span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">출석</span>
                            <span class="stat-count present" id="violin-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">결석</span>
                            <span class="stat-count absent" id="violin-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">미정</span>
                            <span class="stat-count pending" id="violin-pending">4</span>
                        </div>
                        <div class="stat-item" id="violin-holiday-item" style="display: none;">
                            <span class="stat-label">휴강</span>
                            <span class="stat-count holiday" id="violin-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="첼로">
                    <div class="instrument-header">
                        <h4>첼로</h4>
                        <div class="header-right">
                            <span class="member-count" id="cello-count">-명</span>
                            <span class="attendance-rate" id="cello-rate"></span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">출석</span>
                            <span class="stat-count present" id="cello-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">결석</span>
                            <span class="stat-count absent" id="cello-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">미정</span>
                            <span class="stat-count pending" id="cello-pending">5</span>
                        </div>
                        <div class="stat-item" id="cello-holiday-item" style="display: none;">
                            <span class="stat-label">휴강</span>
                            <span class="stat-count holiday" id="cello-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="플룻">
                    <div class="instrument-header">
                        <h4>플룻</h4>
                        <div class="header-right">
                            <span class="member-count" id="flute-count">-명</span>
                            <span class="attendance-rate" id="flute-rate"></span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">출석</span>
                            <span class="stat-count present" id="flute-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">결석</span>
                            <span class="stat-count absent" id="flute-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">미정</span>
                            <span class="stat-count pending" id="flute-pending">3</span>
                        </div>
                        <div class="stat-item" id="flute-holiday-item" style="display: none;">
                            <span class="stat-label">휴강</span>
                            <span class="stat-count holiday" id="flute-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="클라리넷">
                    <div class="instrument-header">
                        <h4>클라리넷</h4>
                        <div class="header-right">
                            <span class="member-count" id="clarinet-count">-명</span>
                            <span class="attendance-rate" id="clarinet-rate"></span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">출석</span>
                            <span class="stat-count present" id="clarinet-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">결석</span>
                            <span class="stat-count absent" id="clarinet-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">미정</span>
                            <span class="stat-count pending" id="clarinet-pending">5</span>
                        </div>
                        <div class="stat-item" id="clarinet-holiday-item" style="display: none;">
                            <span class="stat-label">휴강</span>
                            <span class="stat-count holiday" id="clarinet-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="피아노">
                    <div class="instrument-header">
                        <h4>피아노</h4>
                        <div class="header-right">
                            <span class="member-count" id="piano-count">-명</span>
                            <span class="attendance-rate" id="piano-rate"></span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">출석</span>
                            <span class="stat-count present" id="piano-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">결석</span>
                            <span class="stat-count absent" id="piano-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">미정</span>
                            <span class="stat-count pending" id="piano-pending">1</span>
                        </div>
                        <div class="stat-item" id="piano-holiday-item" style="display: none;">
                            <span class="stat-label">휴강</span>
                            <span class="stat-count holiday" id="piano-holiday">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="member-list" id="memberList">
            <!-- 멤버 목록이 여기에 동적으로 생성됩니다 -->
        </div>

        <div class="sync-status-section">
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator" id="syncIndicator">●</span>
                <span class="sync-text" id="syncText">동기화 준비됨</span>
            </div>
        </div>
    </div>

    <!-- 회원 관리 모달 -->
    <div id="memberManageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>회원 관리</h2>
                <button id="closeModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-list-header">
                    <button id="addMemberBtn" class="add-member-btn">+ 회원 추가</button>
                </div>
                <div id="memberManageList" class="member-manage-list">
                    <!-- 회원 목록이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 회원 추가/수정 모달 -->
    <div id="memberFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="memberFormTitle">회원 추가</h2>
                <button id="closeFormModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="memberForm" class="member-form">
                    <div class="form-group">
                        <label for="memberName">이름:</label>
                        <input type="text" id="memberName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="memberInstrument">악기:</label>
                        <select id="memberInstrument" name="instrument" required>
                            <option value="">악기를 선택하세요</option>
                            <option value="바이올린">바이올린</option>
                            <option value="첼로">첼로</option>
                            <option value="플룻">플룻</option>
                            <option value="클라리넷">클라리넷</option>
                            <option value="피아노">피아노</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelMemberBtn" class="cancel-btn">취소</button>
                        <button type="submit" id="saveMemberBtn" class="save-btn">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 악보 관리 모달 -->
    <div id="sheetMusicManageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>악보 관리</h2>
                <button id="closeSheetMusicModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="sheet-music-list-header">
                    <button id="addSheetMusicBtn" class="add-sheet-music-btn">+ 악보 추가</button>
                    <div class="search-box">
                        <input type="text" id="sheetMusicSearch" placeholder="악보 검색...">
                    </div>
                </div>
                <div id="sheetMusicList" class="sheet-music-list">
                    <!-- 악보 목록이 여기에 동적으로 추가됩니다 -->
                </div>
                <div id="fileModal" class="modal">
                    <div class="modal-content file-modal-content">
                        <div class="modal-header">
                            <h2 id="fileModalTitle">첨부파일</h2>
                            <button id="closeFileModal" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="fileList" class="file-list">
                                <!-- 첨부파일 목록이 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 악보 상세보기 모달 -->
                <div id="sheetDetailModal" class="modal">
                    <div class="modal-content sheet-detail-modal-content">
                        <div class="modal-header">
                            <h2 id="sheetDetailTitle">악보 상세정보</h2>
                            <button id="closeSheetDetailModal" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="sheetDetailContent" class="sheet-detail-content">
                                <!-- 악보 상세 정보가 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>악보 관리 접근</h2>
                <button id="closePasswordModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="passwordInput">비밀번호를 입력하세요:</label>
                    <input type="password" id="passwordInput" placeholder="비밀번호 입력" autocomplete="off">
                </div>
                <div class="modal-actions">
                    <button type="button" id="confirmPasswordBtn" class="save-btn">확인</button>
                    <button type="button" id="cancelPasswordBtn" class="cancel-btn">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 연습곡 관리 모달 -->
    <div id="practiceSongManageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>연습곡 관리</h2>
                <button id="closePracticeSongModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="practice-song-list-header">
                    <button id="addPracticeSongBtn" class="add-practice-song-btn">+ 연습곡 추가</button>
                    <div class="search-box">
                        <input type="text" id="practiceSongSearchInput" placeholder="연습곡 검색...">
                    </div>
                </div>
                <div id="practiceSongManageList" class="practice-song-manage-list">
                    <!-- 연습곡 목록이 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 연습곡 추가/수정 모달 -->
    <div id="practiceSongFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="practiceSongFormTitle">연습곡 추가</h2>
                <button id="closePracticeSongFormModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="practiceSongForm" class="practice-song-form">
                    <div class="form-group">
                        <label for="practiceSongTitle">곡명 *</label>
                        <input type="text" id="practiceSongTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="practiceSongComposer">작곡가</label>
                        <input type="text" id="practiceSongComposer" name="composer">
                    </div>
                    <div class="form-group">
                        <label for="practiceSongDescription">설명</label>
                        <textarea id="practiceSongDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="practiceSongDifficulty">난이도</label>
                        <select id="practiceSongDifficulty" name="difficulty">
                            <option value="쉬움">쉬움</option>
                            <option value="보통">보통</option>
                            <option value="어려움">어려움</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelPracticeSongBtn" class="cancel-btn">취소</button>
                        <button type="submit" class="save-btn">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 차수별 연습곡 설정 모달 -->
    <div id="sessionPracticeSongModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>차수별 연습곡 설정</h2>
                <button id="closeSessionPracticeSongModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="session-practice-song-content">
                    <div class="session-selector">
                        <label for="sessionPracticeSongSelect">회차 선택:</label>
                        <select id="sessionPracticeSongSelect">
                            <option value="1">1회차</option>
                            <option value="2">2회차</option>
                            <option value="3">3회차</option>
                            <option value="4">4회차</option>
                            <option value="5">휴강</option>
                            <option value="6">휴강</option>
                            <option value="7">5회차</option>
                            <option value="8">6회차</option>
                            <option value="9">7회차</option>
                            <option value="10">8회차</option>
                            <option value="11">9회차</option>
                            <option value="12">10회차</option>
                            <option value="13">11회차</option>
                        </select>
                    </div>
                    <div class="practice-song-assignment">
                        <h3>연습곡 할당</h3>
                        <div id="availablePracticeSongs" class="available-songs">
                            <!-- 사용 가능한 연습곡 목록 -->
                        </div>
                        <div class="assigned-songs">
                            <h4>할당된 연습곡</h4>
                            <div id="assignedPracticeSongs" class="assigned-songs-list">
                                <!-- 할당된 연습곡 목록 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="saveSessionPracticeSongBtn" class="save-btn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 악보 추가/수정 모달 -->
    <div id="sheetMusicFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="sheetMusicFormTitle">악보 추가</h2>
                <button id="closeSheetMusicFormModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sheetMusicForm" class="sheet-music-form">
                    <div class="form-group">
                        <label for="sheetMusicTitle">제목:</label>
                        <input type="text" id="sheetMusicTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicComposer">작곡가:</label>
                        <input type="text" id="sheetMusicComposer" name="composer">
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicArranger">편곡가:</label>
                        <input type="text" id="sheetMusicArranger" name="arranger">
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicGenre">장르:</label>
                        <select id="sheetMusicGenre" name="genre">
                            <option value="">장르를 선택하세요</option>
                            <option value="클래식">클래식</option>
                            <option value="팝">팝</option>
                            <option value="재즈">재즈</option>
                            <option value="영화음악">영화음악</option>
                            <option value="뮤지컬">뮤지컬</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicDifficulty">난이도:</label>
                        <select id="sheetMusicDifficulty" name="difficulty">
                            <option value="">난이도를 선택하세요</option>
                            <option value="초급">초급</option>
                            <option value="중급">중급</option>
                            <option value="고급">고급</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicNotes">메모:</label>
                        <textarea id="sheetMusicNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="sheetMusicFiles">첨부파일:</label>
                        <input type="file" id="sheetMusicFiles" name="files" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.mp3,.wav,.mid,.midi">
                        <div class="file-upload-info">
                            <small>지원 형식: PDF, 이미지(JPG, PNG, GIF), 오디오(MP3, WAV), MIDI</small>
                        </div>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelSheetMusicBtn" class="cancel-btn">취소</button>
                        <button type="submit" id="saveSheetMusicBtn" class="save-btn">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SupabaseAttendanceManager 클래스 동적 정의 -->
    <script>
        console.log('=== SupabaseAttendanceManager 클래스 동적 정의 시작 ===');
        
        // 클래스가 없으면 정의
        if (typeof window.SupabaseAttendanceManager === 'undefined') {
            window.SupabaseAttendanceManager = class SupabaseAttendanceManager {
                constructor() {
                    console.log('SupabaseAttendanceManager 생성자 호출');
                    
                    this.storageKey = 'chamber_attendance_local';
                    this.localData = this.loadLocalData();
                    this.isOnline = navigator.onLine;
                    this.lastSyncTime = 0;
                    this.syncInterval = null;
                    
                    // Supabase 클라이언트 확인
                    if (typeof window.supabaseClient === 'undefined') {
                        console.error('Supabase 클라이언트가 로드되지 않았습니다.');
                        return;
                    }
                    
                    this.supabase = window.supabaseClient;
                    console.log('Supabase 클라이언트 연결 완료');
                    
                    // 초기 동기화 상태 설정
                    this.updateSyncStatus('online', '온라인 상태');
                    
                    this.setupCloudSync();
                    this.initializeDatabase();
                    
                    // 초기 데이터 로드
                    this.loadAllAttendanceData();
                }

                // 로컬 데이터 로드
                loadLocalData() {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        try {
                            return JSON.parse(saved);
                        } catch (e) {
                            console.error('로컬 데이터 로드 실패:', e);
                        }
                    }
                    return {};
                }

                // 로컬 데이터 저장
                saveLocalData() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.localData));
                    } catch (e) {
                        console.error('로컬 데이터 저장 실패:', e);
                    }
                }

                // 데이터베이스 초기화
                async initializeDatabase() {
                    try {
                        console.log('데이터베이스 초기화 시작');
                        
                        // 멤버 데이터가 있는지 확인
                        if (typeof members === 'undefined' || !members || members.length === 0) {
                            console.error('멤버 데이터가 없습니다.');
                            return;
                        }

                        // 멤버 데이터를 데이터베이스에 저장
                        const { data, error } = await this.supabase
                            .from('members')
                            .select('*');

                        if (error) {
                            console.error('멤버 데이터 조회 오류:', error);
                            return;
                        }

                        // 멤버 데이터가 없으면 삽입
                        if (!data || data.length === 0) {
                            console.log('멤버 데이터 삽입 시작');
                            const { error: insertError } = await this.supabase
                                .from('members')
                                .insert(members);

                            if (insertError) {
                                console.error('멤버 데이터 삽입 오류:', insertError);
                            } else {
                                console.log('멤버 데이터 삽입 완료');
                            }
                        } else {
                            console.log('멤버 데이터 이미 존재:', data.length, '명');
                        }

                    } catch (error) {
                        console.error('데이터베이스 초기화 오류:', error);
                    }
                }

                // 클라우드 동기화 설정
                setupCloudSync() {
                    console.log('클라우드 동기화 설정 시작');
                    
                    // 온라인 상태 변경 감지
                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.syncToCloud();
                    });

                    window.addEventListener('offline', () => {
                        this.isOnline = false;
                    });

                    // 주기적 동기화 (5분마다)
                    this.syncInterval = setInterval(() => {
                        if (this.isOnline) {
                            this.syncToCloud();
                        }
                    }, 5 * 60 * 1000);
                }

                // 클라우드로 동기화
                async syncToCloud() {
                    if (!this.isOnline) {
                        console.log('오프라인 상태 - 동기화 건너뜀');
                        return;
                    }

                    try {
                        console.log('클라우드 동기화 시작');
                        
                        // 출석 기록 동기화
                        for (const [key, attendance] of Object.entries(this.localData)) {
                            if (attendance && attendance.member_id && attendance.session) {
                                        const { error } = await this.supabase
                                            .from('attendance_records')
                                            .upsert({
                                                id: attendance.member_id,
                                                session_number: attendance.session,
                                                status: attendance.status
                                            });

                                if (error) {
                                    console.error('출석 기록 동기화 오류:', error);
                                }
                            }
                        }

                        this.lastSyncTime = Date.now();
                        console.log('클라우드 동기화 완료');
                        
                        // 동기화 완료 상태 업데이트
                        this.updateSyncTime();

                    } catch (error) {
                        console.error('클라우드 동기화 오류:', error);
                    }
                }

                // 클라우드에서 동기화
                async syncFromCloud() {
                    if (!this.isOnline) {
                        console.log('오프라인 상태 - 동기화 건너뜀');
                        return;
                    }

                    try {
                        console.log('클라우드에서 동기화 시작');
                        
                        const { data, error } = await this.supabase
                            .from('attendance_records')
                            .select('*');

                        if (error) {
                            console.error('출석 기록 조회 오류:', error);
                            return;
                        }

                        // 로컬 데이터와 비교하여 업데이트
                        if (data) {
                            let hasChanges = false;
                            
                            data.forEach(record => {
                                const key = `${record.id}_${record.session_number}`;
                                const existingData = this.localData[key];
                                
                                if (!existingData || existingData.status !== record.status) {
                                    this.localData[key] = {
                                        member_id: record.id,
                                        session: record.session_number,
                                        status: record.status
                                    };
                                    hasChanges = true;
                                }
                            });

                            if (hasChanges) {
                                this.saveLocalData();
                                this.notifyUIUpdate();
                                console.log('클라우드에서 동기화 완료:', data.length, '개 기록');
                            } else {
                                console.log('데이터 변경 없음');
                            }
                        }

                    } catch (error) {
                        console.error('클라우드에서 동기화 오류:', error);
                    }
                }

                // 출석 상태 설정 (script.js와 호환성을 위해 session, memberNo, status 순서로 매개변수 받음)
                async setAttendance(session, memberNo, status) {
                    console.log(`출석 상태 설정: ${session}, ${memberNo}, ${status}`);
                    
                    const key = `${memberNo}_${session}`;
                    this.localData[key] = {
                        member_id: memberNo,
                        session: session,
                        status: status
                    };

                    this.saveLocalData();

                    // 변경사항 알림
                    this.notifyChange(session, memberNo, status);

                    // 온라인 상태면 클라우드에 동기화
                    if (this.isOnline) {
                        try {
                            const { error } = await this.supabase
                                .from('attendance_records')
                                .upsert({
                                    id: memberNo,
                                    session_number: session,
                                    status: status
                                });

                            if (error) {
                                console.error('출석 상태 저장 오류:', error);
                            } else {
                                console.log('출석 상태 저장 완료');
                            }
                        } catch (error) {
                            console.error('출석 상태 저장 오류:', error);
                        }
                    }

                    return this.localData[key];
                }

                // 출석 상태 조회 (script.js와 호환성을 위해 session, memberNo 순서로 매개변수 받음)
                getAttendance(session, memberNo) {
                    const key = `${memberNo}_${session}`;
                    return this.localData[key] || { status: 'pending' };
                }

                // 모든 출석 데이터를 한 번에 로드
                async loadAllAttendanceData() {
                    if (!this.isOnline) {
                        console.log('오프라인 상태 - 데이터 로드 건너뜀');
                        return;
                    }

                    try {
                        console.log('모든 출석 데이터 로드 시작');
                        
                        const { data, error } = await this.supabase
                            .from('attendance_records')
                            .select('*');

                        if (error) {
                            console.error('출석 데이터 로드 오류:', error);
                            return;
                        }

                        // 로컬 데이터 초기화
                        this.localData = {};

                        // 데이터를 로컬에 저장
                        if (data) {
                            data.forEach(record => {
                                const key = `${record.id}_${record.session_number}`;
                                this.localData[key] = {
                                    member_id: record.id,
                                    session: record.session_number,
                                    status: record.status
                                };
                            });

                            this.saveLocalData();
                            console.log('모든 출석 데이터 로드 완료:', data.length, '개 기록');
                        }

                    } catch (error) {
                        console.error('출석 데이터 로드 오류:', error);
                    }
                }

                // 모든 출석 데이터 조회
                getAllAttendance() {
                    return this.localData;
                }

                // 특정 멤버의 출석 상태 조회 (script.js와 호환성을 위해 session, memberNo 순서로 매개변수 받음)
                getAttendance(session, memberNo) {
                    const key = `${memberNo}_${session}`;
                    const attendance = this.localData[key];
                    
                    if (attendance) {
                        return {
                            status: attendance.status,
                            member_id: attendance.member_id,
                            session: attendance.session
                        };
                    }
                    
                    // 데이터가 없으면 기본값 반환
                    return {
                        status: 'pending',
                        member_id: memberNo,
                        session: session
                    };
                }

                // 세션별 요약 정보
                getSessionSummary(session) {
                    const summary = {
                        present: 0,
                        absent: 0,
                        pending: 0,
                        holiday: 0
                    };

                    // 휴강일인 경우
                    if (HOLIDAY_SESSIONS.includes(session)) {
                        summary.holiday = members.length;
                        return summary;
                    }

                    // 멤버별 출석 상태 확인
                    members.forEach(member => {
                        const attendance = this.getAttendance(session, member.no);
                        const status = attendance.status || 'pending';
                        if (status === 'present') {
                            summary.present++;
                        } else if (status === 'absent') {
                            summary.absent++;
                        } else {
                            summary.pending++;
                        }
                    });

                    return summary;
                }

                // 악기별 요약 정보
                getInstrumentSummary(session) {
                    const instrumentSummary = {};

                    // 악기별로 초기화
                    const instruments = ['바이올린', '첼로', '플룻', '클라리넷', '피아노'];
                    instruments.forEach(instrument => {
                        instrumentSummary[instrument] = {
                            present: 0,
                            absent: 0,
                            pending: 0,
                            holiday: 0,
                            total: 0,
                            attendanceRate: 0 // 출석율 추가
                        };
                    });

                    // 휴강일인 경우 모든 멤버를 휴강으로 처리
                    if (HOLIDAY_SESSIONS.includes(session)) {
                        members.forEach(member => {
                            instrumentSummary[member.instrument].holiday++;
                            instrumentSummary[member.instrument].total++;
                        });
                        return instrumentSummary;
                    }

                    // 각 멤버의 출석 상태를 악기별로 집계
                    members.forEach(member => {
                        const attendance = this.getAttendance(session, member.no);
                        const status = attendance.status || 'pending';
                        instrumentSummary[member.instrument][status]++;
                        instrumentSummary[member.instrument].total++;
                    });

                    // 출석율 계산 (누적)
                    instruments.forEach(instrument => {
                        const summary = instrumentSummary[instrument];
                        if (summary.total > 0) {
                            // 출석율 = (출석 + 결석) 중에서 출석의 비율
                            const totalSessions = summary.present + summary.absent;
                            if (totalSessions > 0) {
                                summary.attendanceRate = Math.round((summary.present / totalSessions) * 100);
                            } else {
                                summary.attendanceRate = 0;
                            }
                        }
                    });

                    return instrumentSummary;
                }

                // 악기별 누적 출석율 계산 (모든 회차)
                getInstrumentCumulativeAttendanceRate() {
                    const instrumentSummary = {};

                    // 악기별로 초기화
                    const instruments = ['바이올린', '첼로', '플룻', '클라리넷', '피아노'];
                    instruments.forEach(instrument => {
                        instrumentSummary[instrument] = {
                            totalPresent: 0,
                            totalAbsent: 0,
                            totalSessions: 0,
                            attendanceRate: 0
                        };
                    });

                    // 모든 회차에 대해 집계 (휴강 제외)
                    for (let session = 1; session <= 12; session++) {
                        if (HOLIDAY_SESSIONS.includes(session)) continue; // 휴강 제외

                        members.forEach(member => {
                            const attendance = this.getAttendance(session, member.no);
                            const status = attendance.status || 'pending';
                            
                            if (status === 'present') {
                                instrumentSummary[member.instrument].totalPresent++;
                                instrumentSummary[member.instrument].totalSessions++;
                            } else if (status === 'absent') {
                                instrumentSummary[member.instrument].totalAbsent++;
                                instrumentSummary[member.instrument].totalSessions++;
                            }
                        });
                    }

                    // 누적 출석율 계산
                    instruments.forEach(instrument => {
                        const summary = instrumentSummary[instrument];
                        if (summary.totalSessions > 0) {
                            summary.attendanceRate = Math.round((summary.totalPresent / summary.totalSessions) * 100);
                        } else {
                            summary.attendanceRate = 0;
                        }
                    });

                    return instrumentSummary;
                }

                // 데이터 저장
                async saveData() {
                    this.saveLocalData();
                    if (this.isOnline) {
                        await this.syncToCloud();
                    }
                    return true;
                }

                // UI 업데이트 알림
                notifyUIUpdate() {
                    const event = new CustomEvent('attendanceUpdated', {
                        detail: { data: this.localData }
                    });
                    window.dispatchEvent(event);
                }

                // 변경사항 감지 (BroadcastChannel 사용)
                listenForChanges(callback) {
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('attendance_channel');
                        channel.onmessage = (event) => {
                            if (event.data.type === 'attendance_change') {
                                callback(event.data);
                            }
                        };
                        return channel;
                    }
                    return null;
                }

                // 변경사항 알림
                notifyChange(session, memberNo, status) {
                    // 다른 탭이나 창에 변경사항 알림
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('attendance_channel');
                        channel.postMessage({
                            type: 'attendance_change',
                            session,
                            memberNo,
                            status,
                            timestamp: Date.now()
                        });
                        channel.close();
                    }
                }

                // 업데이트 확인
                checkForUpdates() {
                    // 페이지 가시성 변경 시 호출되는 함수
                    console.log('업데이트 확인 중...');
                    this.notifyUIUpdate();
                }

                // 동기화 상태 업데이트
                updateSyncStatus(status, message) {
                    const syncText = document.getElementById('syncText');
                    if (syncText) {
                        syncText.textContent = message;
                        syncText.className = `sync-text ${status}`;
                    }
                    console.log(`동기화 상태: ${status} - ${message}`);
                }

                // 동기화 시간 업데이트
                updateSyncTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('ko-KR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    this.updateSyncStatus('synced', `마지막 동기화: ${timeString}`);
                }

                // 구독 정리
                cleanup() {
                    if (this.syncInterval) {
                        clearInterval(this.syncInterval);
                    }
                    
                    if (this.supabase) {
                        this.supabase.removeAllChannels();
                    }
                }
            };
            
            console.log('SupabaseAttendanceManager 클래스 동적 정의 완료');
        }
        
        console.log('=== SupabaseAttendanceManager 클래스 정의 완료 ===');
        console.log('SupabaseAttendanceManager 클래스 등록됨:', typeof window.SupabaseAttendanceManager !== 'undefined');
    </script>
    
    <!-- 스크립트 로드 확인 -->
    <script>
        console.log('=== index.html 스크립트 로드 확인 ===');
        console.log('SupabaseAttendanceManager 클래스 존재:', typeof SupabaseAttendanceManager !== 'undefined');
        console.log('window.SupabaseAttendanceManager 존재:', typeof window.SupabaseAttendanceManager !== 'undefined');
    </script>
    
    <script src="script.js"></script>
    
    <!-- script.js 로드 후 확인 -->
    <script>
        console.log('script.js 로드 완료');
        console.log('members 정의됨:', typeof members !== 'undefined');
        if (typeof members !== 'undefined') {
            console.log('멤버 수:', members.length);
        }
    </script>
</body>
</html>
