<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ë‚´ì²´ì„ë²„ì•™ìƒë¸” ì¶œì„ë¶€ v0.1 </title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo.png" type="image/png">
    <!-- PWA manifestëŠ” ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ CORS ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬ -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#4facfe">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì¶œì„ë¶€">
    
    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="logo.png" alt="ìˆ˜ë‚´ì²´ì„ë²„ì•™ìƒë¸” ë¡œê³ " class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="logo-fallback" style="display: none;">ğŸ¼</div>
            <h1>ìˆ˜ë‚´ì²´ì„ë²„ì•™ìƒë¸” ì¶œì„ë¶€ v0.2</h1>
            <div class="header-actions">
                <button id="memberManageBtn" class="member-manage-btn">íšŒì› ê´€ë¦¬</button>
                <div class="sync-time" id="syncTime">
                    <span class="sync-time-value" id="syncTimeValue">-</span>
                </div>
            </div>
        </header>

        <div class="class-info">
            <h2>25ë…„ ê°€ì„í•™ê¸°</h2>
            <p>ë§¤ì£¼ ì¼ìš”ì¼ | ì´ 12íšŒì°¨</p>
        </div>

        <div class="session-selector">
            <label for="sessionSelect">íšŒì°¨ ì„ íƒ:</label>
            <select id="sessionSelect">
                <option value="1">1íšŒì°¨ (9/7)</option>
                <option value="2">2íšŒì°¨ (9/14)</option>
                <option value="3">3íšŒì°¨ (9/21)</option>
                <option value="4">4íšŒì°¨ (9/28)</option>
                <option value="5">íœ´ê°• (10/5)</option>
                <option value="6">5íšŒì°¨ (10/12)</option>
                <option value="7">6íšŒì°¨ (10/19)</option>
                <option value="8">7íšŒì°¨ (10/26)</option>
                <option value="9">8íšŒì°¨ (11/2)</option>
                <option value="10">9íšŒì°¨ (11/9)</option>
                <option value="11">10íšŒì°¨ (11/16)</option>
                <option value="12">11íšŒì°¨ (11/30) - ì¢…ê°•</option>
            </select>
        </div>


        <div class="attendance-summary">
            <div class="summary-item">
                <span class="summary-label">ì¶œì„:</span>
                <span class="summary-count" id="attendanceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">ê²°ì„:</span>
                <span class="summary-count" id="absenceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">ë¯¸ì •:</span>
                <span class="summary-count" id="pendingCount">0</span>
            </div>
            <div class="summary-item" id="holidaySummary" style="display: none;">
                <span class="summary-label">íœ´ê°•:</span>
                <span class="summary-count" id="holidayCount">0</span>
            </div>
        </div>

        <div class="instrument-summary">
            <h3>ì•…ê¸°ë³„ ì¶œì„ í˜„í™©</h3>
            <div class="instrument-grid">
                <div class="instrument-card" data-instrument="ë°”ì´ì˜¬ë¦°">
                    <div class="instrument-header">
                        <h4>ë°”ì´ì˜¬ë¦°</h4>
                        <div class="header-right">
                            <span class="member-count">4ëª…</span>
                            <span class="attendance-rate" id="violin-rate">ì¶œì„ìœ¨: 0%</span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì¶œì„</span>
                            <span class="stat-count present" id="violin-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê²°ì„</span>
                            <span class="stat-count absent" id="violin-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ë¯¸ì •</span>
                            <span class="stat-count pending" id="violin-pending">4</span>
                        </div>
                        <div class="stat-item" id="violin-holiday-item" style="display: none;">
                            <span class="stat-label">íœ´ê°•</span>
                            <span class="stat-count holiday" id="violin-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="ì²¼ë¡œ">
                    <div class="instrument-header">
                        <h4>ì²¼ë¡œ</h4>
                        <div class="header-right">
                            <span class="member-count">5ëª…</span>
                            <span class="attendance-rate" id="cello-rate">ì¶œì„ìœ¨: 0%</span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì¶œì„</span>
                            <span class="stat-count present" id="cello-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê²°ì„</span>
                            <span class="stat-count absent" id="cello-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ë¯¸ì •</span>
                            <span class="stat-count pending" id="cello-pending">5</span>
                        </div>
                        <div class="stat-item" id="cello-holiday-item" style="display: none;">
                            <span class="stat-label">íœ´ê°•</span>
                            <span class="stat-count holiday" id="cello-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="í”Œë£»">
                    <div class="instrument-header">
                        <h4>í”Œë£»</h4>
                        <div class="header-right">
                            <span class="member-count">3ëª…</span>
                            <span class="attendance-rate" id="flute-rate">ì¶œì„ìœ¨: 0%</span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì¶œì„</span>
                            <span class="stat-count present" id="flute-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê²°ì„</span>
                            <span class="stat-count absent" id="flute-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ë¯¸ì •</span>
                            <span class="stat-count pending" id="flute-pending">3</span>
                        </div>
                        <div class="stat-item" id="flute-holiday-item" style="display: none;">
                            <span class="stat-label">íœ´ê°•</span>
                            <span class="stat-count holiday" id="flute-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="í´ë¼ë¦¬ë„·">
                    <div class="instrument-header">
                        <h4>í´ë¼ë¦¬ë„·</h4>
                        <div class="header-right">
                            <span class="member-count">5ëª…</span>
                            <span class="attendance-rate" id="clarinet-rate">ì¶œì„ìœ¨: 0%</span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì¶œì„</span>
                            <span class="stat-count present" id="clarinet-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê²°ì„</span>
                            <span class="stat-count absent" id="clarinet-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ë¯¸ì •</span>
                            <span class="stat-count pending" id="clarinet-pending">5</span>
                        </div>
                        <div class="stat-item" id="clarinet-holiday-item" style="display: none;">
                            <span class="stat-label">íœ´ê°•</span>
                            <span class="stat-count holiday" id="clarinet-holiday">0</span>
                        </div>
                    </div>
                </div>

                <div class="instrument-card" data-instrument="í”¼ì•„ë…¸">
                    <div class="instrument-header">
                        <h4>í”¼ì•„ë…¸</h4>
                        <div class="header-right">
                            <span class="member-count">1ëª…</span>
                            <span class="attendance-rate" id="piano-rate">ì¶œì„ìœ¨: 0%</span>
                        </div>
                    </div>
                    <div class="instrument-stats">
                        <div class="stat-item">
                            <span class="stat-label">ì¶œì„</span>
                            <span class="stat-count present" id="piano-present">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê²°ì„</span>
                            <span class="stat-count absent" id="piano-absent">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ë¯¸ì •</span>
                            <span class="stat-count pending" id="piano-pending">1</span>
                        </div>
                        <div class="stat-item" id="piano-holiday-item" style="display: none;">
                            <span class="stat-label">íœ´ê°•</span>
                            <span class="stat-count holiday" id="piano-holiday">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="member-list" id="memberList">
            <!-- ë©¤ë²„ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>

        <div class="sync-status-section">
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator" id="syncIndicator">â—</span>
                <span class="sync-text" id="syncText">ë™ê¸°í™” ì¤€ë¹„ë¨</span>
            </div>
        </div>
    </div>

    <!-- íšŒì› ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="memberManageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>íšŒì› ê´€ë¦¬</h2>
                <button id="closeModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-list-header">
                    <button id="addMemberBtn" class="add-member-btn">+ íšŒì› ì¶”ê°€</button>
                </div>
                <div id="memberManageList" class="member-manage-list">
                    <!-- íšŒì› ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- íšŒì› ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="memberFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="memberFormTitle">íšŒì› ì¶”ê°€</h2>
                <button id="closeFormModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="memberForm" class="member-form">
                    <div class="form-group">
                        <label for="memberName">ì´ë¦„:</label>
                        <input type="text" id="memberName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="memberInstrument">ì•…ê¸°:</label>
                        <select id="memberInstrument" name="instrument" required>
                            <option value="">ì•…ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ë°”ì´ì˜¬ë¦°">ë°”ì´ì˜¬ë¦°</option>
                            <option value="ì²¼ë¡œ">ì²¼ë¡œ</option>
                            <option value="í”Œë£»">í”Œë£»</option>
                            <option value="í´ë¼ë¦¬ë„·">í´ë¼ë¦¬ë„·</option>
                            <option value="í”¼ì•„ë…¸">í”¼ì•„ë…¸</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelMemberBtn" class="cancel-btn">ì·¨ì†Œ</button>
                        <button type="submit" id="saveMemberBtn" class="save-btn">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SupabaseAttendanceManager í´ë˜ìŠ¤ ë™ì  ì •ì˜ -->
    <script>
        console.log('=== SupabaseAttendanceManager í´ë˜ìŠ¤ ë™ì  ì •ì˜ ì‹œì‘ ===');
        
        // í´ë˜ìŠ¤ê°€ ì—†ìœ¼ë©´ ì •ì˜
        if (typeof window.SupabaseAttendanceManager === 'undefined') {
            window.SupabaseAttendanceManager = class SupabaseAttendanceManager {
                constructor() {
                    console.log('SupabaseAttendanceManager ìƒì„±ì í˜¸ì¶œ');
                    
                    this.storageKey = 'chamber_attendance_local';
                    this.localData = this.loadLocalData();
                    this.isOnline = navigator.onLine;
                    this.lastSyncTime = 0;
                    this.syncInterval = null;
                    
                    // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
                    if (typeof window.supabaseClient === 'undefined') {
                        console.error('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    this.supabase = window.supabaseClient;
                    console.log('Supabase í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì™„ë£Œ');
                    
                    // ì´ˆê¸° ë™ê¸°í™” ìƒíƒœ ì„¤ì •
                    this.updateSyncStatus('online', 'ì˜¨ë¼ì¸ ìƒíƒœ');
                    
                    this.setupCloudSync();
                    this.initializeDatabase();
                    
                    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                    this.loadAllAttendanceData();
                }

                // ë¡œì»¬ ë°ì´í„° ë¡œë“œ
                loadLocalData() {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        try {
                            return JSON.parse(saved);
                        } catch (e) {
                            console.error('ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                        }
                    }
                    return {};
                }

                // ë¡œì»¬ ë°ì´í„° ì €ì¥
                saveLocalData() {
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(this.localData));
                    } catch (e) {
                        console.error('ë¡œì»¬ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
                    }
                }

                // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                async initializeDatabase() {
                    try {
                        console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹œì‘');
                        
                        // ë©¤ë²„ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                        if (typeof members === 'undefined' || !members || members.length === 0) {
                            console.error('ë©¤ë²„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        // ë©¤ë²„ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                        const { data, error } = await this.supabase
                            .from('members')
                            .select('*');

                        if (error) {
                            console.error('ë©¤ë²„ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
                            return;
                        }

                        // ë©¤ë²„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‚½ì…
                        if (!data || data.length === 0) {
                            console.log('ë©¤ë²„ ë°ì´í„° ì‚½ì… ì‹œì‘');
                            const { error: insertError } = await this.supabase
                                .from('members')
                                .insert(members);

                            if (insertError) {
                                console.error('ë©¤ë²„ ë°ì´í„° ì‚½ì… ì˜¤ë¥˜:', insertError);
                            } else {
                                console.log('ë©¤ë²„ ë°ì´í„° ì‚½ì… ì™„ë£Œ');
                            }
                        } else {
                            console.log('ë©¤ë²„ ë°ì´í„° ì´ë¯¸ ì¡´ì¬:', data.length, 'ëª…');
                        }

                    } catch (error) {
                        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    }
                }

                // í´ë¼ìš°ë“œ ë™ê¸°í™” ì„¤ì •
                setupCloudSync() {
                    console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ì„¤ì • ì‹œì‘');
                    
                    // ì˜¨ë¼ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.syncToCloud();
                    });

                    window.addEventListener('offline', () => {
                        this.isOnline = false;
                    });

                    // ì£¼ê¸°ì  ë™ê¸°í™” (5ë¶„ë§ˆë‹¤)
                    this.syncInterval = setInterval(() => {
                        if (this.isOnline) {
                            this.syncToCloud();
                        }
                    }, 5 * 60 * 1000);
                }

                // í´ë¼ìš°ë“œë¡œ ë™ê¸°í™”
                async syncToCloud() {
                    if (!this.isOnline) {
                        console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë™ê¸°í™” ê±´ë„ˆëœ€');
                        return;
                    }

                    try {
                        console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹œì‘');
                        
                        // ì¶œì„ ê¸°ë¡ ë™ê¸°í™”
                        for (const [key, attendance] of Object.entries(this.localData)) {
                            if (attendance && attendance.member_id && attendance.session) {
                                        const { error } = await this.supabase
                                            .from('attendance_records')
                                            .upsert({
                                                id: attendance.member_id,
                                                session_number: attendance.session,
                                                status: attendance.status
                                            });

                                if (error) {
                                    console.error('ì¶œì„ ê¸°ë¡ ë™ê¸°í™” ì˜¤ë¥˜:', error);
                                }
                            }
                        }

                        this.lastSyncTime = Date.now();
                        console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ');
                        
                        // ë™ê¸°í™” ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
                        this.updateSyncTime();

                    } catch (error) {
                        console.error('í´ë¼ìš°ë“œ ë™ê¸°í™” ì˜¤ë¥˜:', error);
                    }
                }

                // í´ë¼ìš°ë“œì—ì„œ ë™ê¸°í™”
                async syncFromCloud() {
                    if (!this.isOnline) {
                        console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë™ê¸°í™” ê±´ë„ˆëœ€');
                        return;
                    }

                    try {
                        console.log('í´ë¼ìš°ë“œì—ì„œ ë™ê¸°í™” ì‹œì‘');
                        
                        const { data, error } = await this.supabase
                            .from('attendance_records')
                            .select('*');

                        if (error) {
                            console.error('ì¶œì„ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
                            return;
                        }

                        // ë¡œì»¬ ë°ì´í„°ì™€ ë¹„êµí•˜ì—¬ ì—…ë°ì´íŠ¸
                        if (data) {
                            let hasChanges = false;
                            
                            data.forEach(record => {
                                const key = `${record.id}_${record.session_number}`;
                                const existingData = this.localData[key];
                                
                                if (!existingData || existingData.status !== record.status) {
                                    this.localData[key] = {
                                        member_id: record.id,
                                        session: record.session_number,
                                        status: record.status
                                    };
                                    hasChanges = true;
                                }
                            });

                            if (hasChanges) {
                                this.saveLocalData();
                                this.notifyUIUpdate();
                                console.log('í´ë¼ìš°ë“œì—ì„œ ë™ê¸°í™” ì™„ë£Œ:', data.length, 'ê°œ ê¸°ë¡');
                            } else {
                                console.log('ë°ì´í„° ë³€ê²½ ì—†ìŒ');
                            }
                        }

                    } catch (error) {
                        console.error('í´ë¼ìš°ë“œì—ì„œ ë™ê¸°í™” ì˜¤ë¥˜:', error);
                    }
                }

                // ì¶œì„ ìƒíƒœ ì„¤ì • (script.jsì™€ í˜¸í™˜ì„±ì„ ìœ„í•´ session, memberNo, status ìˆœì„œë¡œ ë§¤ê°œë³€ìˆ˜ ë°›ìŒ)
                async setAttendance(session, memberNo, status) {
                    console.log(`ì¶œì„ ìƒíƒœ ì„¤ì •: ${session}, ${memberNo}, ${status}`);
                    
                    const key = `${memberNo}_${session}`;
                    this.localData[key] = {
                        member_id: memberNo,
                        session: session,
                        status: status
                    };

                    this.saveLocalData();

                    // ë³€ê²½ì‚¬í•­ ì•Œë¦¼
                    this.notifyChange(session, memberNo, status);

                    // ì˜¨ë¼ì¸ ìƒíƒœë©´ í´ë¼ìš°ë“œì— ë™ê¸°í™”
                    if (this.isOnline) {
                        try {
                            const { error } = await this.supabase
                                .from('attendance_records')
                                .upsert({
                                    id: memberNo,
                                    session_number: session,
                                    status: status
                                });

                            if (error) {
                                console.error('ì¶œì„ ìƒíƒœ ì €ì¥ ì˜¤ë¥˜:', error);
                            } else {
                                console.log('ì¶œì„ ìƒíƒœ ì €ì¥ ì™„ë£Œ');
                            }
                        } catch (error) {
                            console.error('ì¶œì„ ìƒíƒœ ì €ì¥ ì˜¤ë¥˜:', error);
                        }
                    }

                    return this.localData[key];
                }

                // ì¶œì„ ìƒíƒœ ì¡°íšŒ (script.jsì™€ í˜¸í™˜ì„±ì„ ìœ„í•´ session, memberNo ìˆœì„œë¡œ ë§¤ê°œë³€ìˆ˜ ë°›ìŒ)
                getAttendance(session, memberNo) {
                    const key = `${memberNo}_${session}`;
                    return this.localData[key] || { status: 'pending' };
                }

                // ëª¨ë“  ì¶œì„ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë¡œë“œ
                async loadAllAttendanceData() {
                    if (!this.isOnline) {
                        console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë°ì´í„° ë¡œë“œ ê±´ë„ˆëœ€');
                        return;
                    }

                    try {
                        console.log('ëª¨ë“  ì¶œì„ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                        
                        const { data, error } = await this.supabase
                            .from('attendance_records')
                            .select('*');

                        if (error) {
                            console.error('ì¶œì„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                            return;
                        }

                        // ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
                        this.localData = {};

                        // ë°ì´í„°ë¥¼ ë¡œì»¬ì— ì €ì¥
                        if (data) {
                            data.forEach(record => {
                                const key = `${record.id}_${record.session_number}`;
                                this.localData[key] = {
                                    member_id: record.id,
                                    session: record.session_number,
                                    status: record.status
                                };
                            });

                            this.saveLocalData();
                            console.log('ëª¨ë“  ì¶œì„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', data.length, 'ê°œ ê¸°ë¡');
                        }

                    } catch (error) {
                        console.error('ì¶œì„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    }
                }

                // ëª¨ë“  ì¶œì„ ë°ì´í„° ì¡°íšŒ
                getAllAttendance() {
                    return this.localData;
                }

                // íŠ¹ì • ë©¤ë²„ì˜ ì¶œì„ ìƒíƒœ ì¡°íšŒ (script.jsì™€ í˜¸í™˜ì„±ì„ ìœ„í•´ session, memberNo ìˆœì„œë¡œ ë§¤ê°œë³€ìˆ˜ ë°›ìŒ)
                getAttendance(session, memberNo) {
                    const key = `${memberNo}_${session}`;
                    const attendance = this.localData[key];
                    
                    if (attendance) {
                        return {
                            status: attendance.status,
                            member_id: attendance.member_id,
                            session: attendance.session
                        };
                    }
                    
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
                    return {
                        status: 'pending',
                        member_id: memberNo,
                        session: session
                    };
                }

                // ì„¸ì…˜ë³„ ìš”ì•½ ì •ë³´
                getSessionSummary(session) {
                    const summary = {
                        present: 0,
                        absent: 0,
                        pending: 0,
                        holiday: 0
                    };

                    // íœ´ê°•ì¼ì¸ ê²½ìš°
                    if (HOLIDAY_SESSIONS.includes(session)) {
                        summary.holiday = members.length;
                        return summary;
                    }

                    // ë©¤ë²„ë³„ ì¶œì„ ìƒíƒœ í™•ì¸
                    members.forEach(member => {
                        const attendance = this.getAttendance(session, member.no);
                        const status = attendance.status || 'pending';
                        if (status === 'present') {
                            summary.present++;
                        } else if (status === 'absent') {
                            summary.absent++;
                        } else {
                            summary.pending++;
                        }
                    });

                    return summary;
                }

                // ì•…ê¸°ë³„ ìš”ì•½ ì •ë³´
                getInstrumentSummary(session) {
                    const instrumentSummary = {};

                    // ì•…ê¸°ë³„ë¡œ ì´ˆê¸°í™”
                    const instruments = ['ë°”ì´ì˜¬ë¦°', 'ì²¼ë¡œ', 'í”Œë£»', 'í´ë¼ë¦¬ë„·', 'í”¼ì•„ë…¸'];
                    instruments.forEach(instrument => {
                        instrumentSummary[instrument] = {
                            present: 0,
                            absent: 0,
                            pending: 0,
                            holiday: 0,
                            total: 0,
                            attendanceRate: 0 // ì¶œì„ìœ¨ ì¶”ê°€
                        };
                    });

                    // íœ´ê°•ì¼ì¸ ê²½ìš° ëª¨ë“  ë©¤ë²„ë¥¼ íœ´ê°•ìœ¼ë¡œ ì²˜ë¦¬
                    if (HOLIDAY_SESSIONS.includes(session)) {
                        members.forEach(member => {
                            instrumentSummary[member.instrument].holiday++;
                            instrumentSummary[member.instrument].total++;
                        });
                        return instrumentSummary;
                    }

                    // ê° ë©¤ë²„ì˜ ì¶œì„ ìƒíƒœë¥¼ ì•…ê¸°ë³„ë¡œ ì§‘ê³„
                    members.forEach(member => {
                        const attendance = this.getAttendance(session, member.no);
                        const status = attendance.status || 'pending';
                        instrumentSummary[member.instrument][status]++;
                        instrumentSummary[member.instrument].total++;
                    });

                    // ì¶œì„ìœ¨ ê³„ì‚° (ëˆ„ì )
                    instruments.forEach(instrument => {
                        const summary = instrumentSummary[instrument];
                        if (summary.total > 0) {
                            // ì¶œì„ìœ¨ = (ì¶œì„ + ê²°ì„) ì¤‘ì—ì„œ ì¶œì„ì˜ ë¹„ìœ¨
                            const totalSessions = summary.present + summary.absent;
                            if (totalSessions > 0) {
                                summary.attendanceRate = Math.round((summary.present / totalSessions) * 100);
                            } else {
                                summary.attendanceRate = 0;
                            }
                        }
                    });

                    return instrumentSummary;
                }

                // ì•…ê¸°ë³„ ëˆ„ì  ì¶œì„ìœ¨ ê³„ì‚° (ëª¨ë“  íšŒì°¨)
                getInstrumentCumulativeAttendanceRate() {
                    const instrumentSummary = {};

                    // ì•…ê¸°ë³„ë¡œ ì´ˆê¸°í™”
                    const instruments = ['ë°”ì´ì˜¬ë¦°', 'ì²¼ë¡œ', 'í”Œë£»', 'í´ë¼ë¦¬ë„·', 'í”¼ì•„ë…¸'];
                    instruments.forEach(instrument => {
                        instrumentSummary[instrument] = {
                            totalPresent: 0,
                            totalAbsent: 0,
                            totalSessions: 0,
                            attendanceRate: 0
                        };
                    });

                    // ëª¨ë“  íšŒì°¨ì— ëŒ€í•´ ì§‘ê³„ (íœ´ê°• ì œì™¸)
                    for (let session = 1; session <= 12; session++) {
                        if (HOLIDAY_SESSIONS.includes(session)) continue; // íœ´ê°• ì œì™¸

                        members.forEach(member => {
                            const attendance = this.getAttendance(session, member.no);
                            const status = attendance.status || 'pending';
                            
                            if (status === 'present') {
                                instrumentSummary[member.instrument].totalPresent++;
                                instrumentSummary[member.instrument].totalSessions++;
                            } else if (status === 'absent') {
                                instrumentSummary[member.instrument].totalAbsent++;
                                instrumentSummary[member.instrument].totalSessions++;
                            }
                        });
                    }

                    // ëˆ„ì  ì¶œì„ìœ¨ ê³„ì‚°
                    instruments.forEach(instrument => {
                        const summary = instrumentSummary[instrument];
                        if (summary.totalSessions > 0) {
                            summary.attendanceRate = Math.round((summary.totalPresent / summary.totalSessions) * 100);
                        } else {
                            summary.attendanceRate = 0;
                        }
                    });

                    return instrumentSummary;
                }

                // ë°ì´í„° ì €ì¥
                async saveData() {
                    this.saveLocalData();
                    if (this.isOnline) {
                        await this.syncToCloud();
                    }
                    return true;
                }

                // UI ì—…ë°ì´íŠ¸ ì•Œë¦¼
                notifyUIUpdate() {
                    const event = new CustomEvent('attendanceUpdated', {
                        detail: { data: this.localData }
                    });
                    window.dispatchEvent(event);
                }

                // ë³€ê²½ì‚¬í•­ ê°ì§€ (BroadcastChannel ì‚¬ìš©)
                listenForChanges(callback) {
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('attendance_channel');
                        channel.onmessage = (event) => {
                            if (event.data.type === 'attendance_change') {
                                callback(event.data);
                            }
                        };
                        return channel;
                    }
                    return null;
                }

                // ë³€ê²½ì‚¬í•­ ì•Œë¦¼
                notifyChange(session, memberNo, status) {
                    // ë‹¤ë¥¸ íƒ­ì´ë‚˜ ì°½ì— ë³€ê²½ì‚¬í•­ ì•Œë¦¼
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('attendance_channel');
                        channel.postMessage({
                            type: 'attendance_change',
                            session,
                            memberNo,
                            status,
                            timestamp: Date.now()
                        });
                        channel.close();
                    }
                }

                // ì—…ë°ì´íŠ¸ í™•ì¸
                checkForUpdates() {
                    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
                    console.log('ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘...');
                    this.notifyUIUpdate();
                }

                // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
                updateSyncStatus(status, message) {
                    const syncText = document.getElementById('syncText');
                    if (syncText) {
                        syncText.textContent = message;
                        syncText.className = `sync-text ${status}`;
                    }
                    console.log(`ë™ê¸°í™” ìƒíƒœ: ${status} - ${message}`);
                }

                // ë™ê¸°í™” ì‹œê°„ ì—…ë°ì´íŠ¸
                updateSyncTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('ko-KR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    this.updateSyncStatus('synced', `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${timeString}`);
                }

                // êµ¬ë… ì •ë¦¬
                cleanup() {
                    if (this.syncInterval) {
                        clearInterval(this.syncInterval);
                    }
                    
                    if (this.supabase) {
                        this.supabase.removeAllChannels();
                    }
                }
            };
            
            console.log('SupabaseAttendanceManager í´ë˜ìŠ¤ ë™ì  ì •ì˜ ì™„ë£Œ');
        }
        
        console.log('=== SupabaseAttendanceManager í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ ===');
        console.log('SupabaseAttendanceManager í´ë˜ìŠ¤ ë“±ë¡ë¨:', typeof window.SupabaseAttendanceManager !== 'undefined');
    </script>
    
    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ -->
    <script>
        console.log('=== index.html ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ ===');
        console.log('SupabaseAttendanceManager í´ë˜ìŠ¤ ì¡´ì¬:', typeof SupabaseAttendanceManager !== 'undefined');
        console.log('window.SupabaseAttendanceManager ì¡´ì¬:', typeof window.SupabaseAttendanceManager !== 'undefined');
    </script>
    
    <script src="script.js"></script>
    
    <!-- script.js ë¡œë“œ í›„ í™•ì¸ -->
    <script>
        console.log('script.js ë¡œë“œ ì™„ë£Œ');
        console.log('members ì •ì˜ë¨:', typeof members !== 'undefined');
        if (typeof members !== 'undefined') {
            console.log('ë©¤ë²„ ìˆ˜:', members.length);
        }
    </script>
</body>
</html>
